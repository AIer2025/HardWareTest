# R²固定为0.95问题 - 可视化分析

## 🖼️ 问题示意图

### 用户看到的界面

```
┌─────────────────────────────────────────────────────┐
│ 威布尔可靠性分析                                      │
├─────────────────────────────────────────────────────┤
│                                                      │
│ 选择系统: [深圳公司测试中心 ▼]                        │
│                                                      │
│ ┌──────────────────────────────────────────────┐   │
│ │ 基本信息                                      │   │
│ │                                              │   │
│ │ 模组: 移液模组                               │   │
│ │ 样本数: 55                                   │   │
│ │ 分析时间: 2025-11-23 11:34:16               │   │
│ │                                              │   │
│ ├──────────────────────────────────────────────┤   │
│ │ 威布尔参数                                    │   │
│ │                                              │   │
│ │ 形状参数 β: 1.4094         ✅ 正常变化       │   │
│ │ 尺度参数 η: 4216.13 小时    ✅ 正常变化       │   │
│ │                                              │   │
│ ├──────────────────────────────────────────────┤   │
│ │ 可靠性指标                                    │   │
│ │                                              │   │
│ │ 平均寿命 MTTF: 3657.92 小时  ✅ 正常变化      │   │
│ │ B10 寿命: 854.05 小时       ✅ 正常变化       │   │
│ │ B50 寿命: 3250.70 小时      ✅ 正常变化       │   │
│ │ B90 寿命: 7619.25 小时      ✅ 正常变化       │   │
│ │                                              │   │
│ ├──────────────────────────────────────────────┤   │
│ │ 拟合质量                                      │   │
│ │                                              │   │
│ │ 拟合优度 R²: 0.9500  ❌ 始终是0.95，不变化！  │   │
│ │                                              │   │
│ │ R² > 0.95 表示拟合良好                        │   │
│ └──────────────────────────────────────────────┘   │
│                                                      │
│ [开始分析] [保存结果] [导出报告]                      │
└─────────────────────────────────────────────────────┘
```

**现象**：
- ✅ 其他参数（β、η、MTTF、B10/B50/B90）都随模组变化
- ❌ 唯独 R² 始终显示 0.9500
- ❌ 切换不同模组，R² 不会改变

---

## 🔍 代码流程对比

### 当前错误流程

```
用户点击 [开始分析] 按钮
         ↓
═══════════════════════════════════════════════════════════
ViewModel.Analyze()  (第474行)
═══════════════════════════════════════════════════════════
         ↓
    准备数据
    ├─ failures = 失效数据
    └─ suspensions = 删尾数据
         ↓
┌────────────────────────────────────────────────────────┐
│ 调用 Service.CalculateWeibullParameters()              │
│     ↓                                                  │
│   返回: (beta, eta)                                    │
│     ✅ β = 1.4094                                      │
│     ✅ η = 4216.13                                     │
│     ❌ 没有 R²！                                       │
└────────────────────────────────────────────────────────┘
         ↓
    设置结果
    ├─ Beta = beta       ✅
    ├─ Eta = eta         ✅
    ├─ MTTF = 计算...    ✅
    ├─ B10 = 计算...     ✅
    └─ ...
         ↓
┌────────────────────────────────────────────────────────┐
│ 调用 ViewModel.CalculateRSquared(failures)            │
│     ↓                                                  │
│   准备数据...                                          │
│   计算开始...                                          │
│     ↓                                                  │
│   ❌ return 0.95;  ← 硬编码！永远返回0.95              │
└────────────────────────────────────────────────────────┘
         ↓
    RSquared = 0.95  ❌ 问题！
         ↓
    显示在界面上
         ↓
    用户看到固定的 0.9500
```

---

### 修复后正确流程（方案1）

```
用户点击 [开始分析] 按钮
         ↓
═══════════════════════════════════════════════════════════
ViewModel.Analyze()  (修改后)
═══════════════════════════════════════════════════════════
         ↓
    准备数据
    ├─ allTimes = [所有时间]
    └─ isCensored = [删尾标记]
         ↓
┌────────────────────────────────────────────────────────┐
│ 调用 Service.AnalyzeWithEngine(allTimes, isCensored)  │
│     ↓                                                  │
│ ┌──────────────────────────────────────────────────┐ │
│ │ WeibullEngine.Analyze()                          │ │
│ │     ↓                                            │ │
│ │   MLE参数估计                                    │ │
│ │   ├─ β = 1.4094                                 │ │
│ │   └─ η = 4216.13                                │ │
│ │     ↓                                            │ │
│ │   计算可靠性指标                                  │ │
│ │   ├─ MTTF = 3657.92                             │ │
│ │   ├─ B10 = 854.05                               │ │
│ │   └─ ...                                        │ │
│ │     ↓                                            │ │
│ │   ✅ 正确计算R² (Pearson相关系数²)               │ │
│ │   ├─ 提取失效数据                                │ │
│ │   ├─ 线性化: X=ln(t), Y=ln(-ln(1-F))           │ │
│ │   ├─ 计算相关系数 r                             │ │
│ │   └─ R² = r²                                    │ │
│ │     ↓                                            │ │
│ │   返回 WeibullResult {                          │ │
│ │     Beta = 1.4094,                              │ │
│ │     Eta = 4216.13,                              │ │
│ │     RSquared = 0.9823,  ← ✅ 正确的R²值         │ │
│ │     MTTF = 3657.92,                             │ │
│ │     B10Life = 854.05,                           │ │
│ │     ...                                         │ │
│ │   }                                             │ │
│ └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
         ↓
    设置所有结果
    ├─ Beta = result.Beta              ✅
    ├─ Eta = result.Eta                ✅
    ├─ RSquared = result.RSquared      ✅ 正确的R²
    ├─ MTTF = result.MTTF              ✅
    ├─ B10Life = result.B10Life        ✅
    └─ ...
         ↓
    显示在界面上
         ↓
    用户看到正确的R²值（如 0.9823）
    不同模组有不同的R²值 ✅
```

---

## 📊 数据流对比图

### 错误的数据流

```
TestData (55条)
    ↓
┌─────────────────┐
│ 失效: 40条       │ ────┐
└─────────────────┘     │
                        ├──→ CalculateWeibullParameters()
┌─────────────────┐     │         ↓
│ 删尾: 15条       │ ────┘    返回 (β, η)
└─────────────────┘
    ↓
只用失效数据 (40条)
    ↓
CalculateRSquared()
    ↓
准备数据 (正确)
计算开始 (正确)
    ↓
return 0.95;  ❌ 硬编码！
```

### 正确的数据流

```
TestData (55条)
    ↓
allTimes = [55个时间值]
isCensored = [55个true/false标记]
    ↓
WeibullEngine.Analyze(allTimes, isCensored)
    ↓
┌──────────────────────────────────────────┐
│ Engine内部:                               │
│                                          │
│ 1. MLE参数估计 (使用所有数据)             │
│    ├─ 失效数据: 计算likelihood            │
│    └─ 删尾数据: 参与likelihood            │
│         ↓                                │
│    (β=1.4094, η=4216.13)                 │
│                                          │
│ 2. 计算R² (只用失效数据)                  │
│    ├─ 提取40个失效数据                    │
│    ├─ 线性化Weibull                      │
│    ├─ 计算Pearson相关系数 r              │
│    └─ R² = r² = 0.9823 ✅                │
│                                          │
│ 3. 计算可靠性指标                         │
│    ├─ MTTF = η·Γ(1+1/β)                 │
│    ├─ B10 = η·(-ln(0.9))^(1/β)          │
│    └─ ...                                │
└──────────────────────────────────────────┘
    ↓
返回完整的 WeibullResult
    ↓
所有参数都正确 ✅
```

---

## 🎨 R²值变化示例

### 修复前（错误）

```
模组A: β=1.5, η=3000  → R²=0.9500 ❌
模组B: β=2.0, η=4000  → R²=0.9500 ❌
模组C: β=1.2, η=2500  → R²=0.9500 ❌
模组D: β=3.0, η=5000  → R²=0.9500 ❌

所有模组的R²都是0.95！明显不对！
```

### 修复后（正确）

```
模组A: β=1.5, η=3000  → R²=0.9823 ✅
模组B: β=2.0, η=4000  → R²=0.9654 ✅
模组C: β=1.2, η=2500  → R²=0.9912 ✅
模组D: β=3.0, η=5000  → R²=0.8876 ✅

每个模组的R²值都不同，反映真实拟合质量！
```

---

## 🔧 代码位置标注

### WeibullAnalysisViewModel.cs

```
第1行   ┐
        │  头部导入
第20行  ┘
        
第474行 ┐
        │
        │  Analyze() 方法
        │  
第525行 │  ← 调用 CalculateWeibullParameters()
        │
第546行 │  ← 调用 CalculateRSquared()  ❌ 问题位置
        │
第600行 ┘
        
第688行 ┐
        │  CalculateRSquared() 方法
        │
第701行 │  ← return 0.95;  ❌ 硬编码位置！
        │
第708行 ┘

第722行 (文件结束)
```

---

## 🎯 关键代码片段对比

### 问题代码（第688-708行）

```csharp
private double CalculateRSquared(double[] failures)
{
    try
    {
        if (failures.Length < 2) return 0;
        
        double[] sorted = failures.OrderBy(t => t).ToArray();
        double[] x = sorted.Select(t => Math.Log(t)).ToArray();
        double meanX = x.Average();
        
        double ssTot = x.Sum(xi => Math.Pow(xi - meanX, 2));
        if (ssTot == 0) return 0;
        
        return 0.95;  // ❌❌❌ 这里！永远返回0.95！
    }
    catch (Exception ex)
    {
        SimpleLogger.Error("计算R²时发生错误", ex);
        return 0;
    }
}
```

**问题**：
- 前面的代码都是在准备数据
- 但最后直接 `return 0.95;`
- 完全没有实际计算！
- 就像：准备了所有食材，然后直接扔掉，从外卖店买了现成的！

---

### 正确代码（方案2修复后）

```csharp
private double CalculateRSquared(double[] failures)
{
    try
    {
        if (failures.Length < 2) return 0;
        
        var sorted = failures.OrderBy(t => t).ToArray();
        int n = sorted.Length;
        
        // 准备线性化数据
        double[] x = new double[n];
        double[] y = new double[n];
        
        for (int i = 0; i < n; i++)
        {
            double rank = i + 1;
            double F = (rank - 0.3) / (n + 0.4);
            x[i] = Math.Log(sorted[i]);
            y[i] = Math.Log(-Math.Log(1 - F));
        }
        
        // 计算Pearson相关系数
        double xMean = x.Average();
        double yMean = y.Average();
        
        double sumXY = 0, sumXX = 0, sumYY = 0;
        for (int i = 0; i < n; i++)
        {
            double dx = x[i] - xMean;
            double dy = y[i] - yMean;
            sumXY += dx * dy;
            sumXX += dx * dx;
            sumYY += dy * dy;
        }
        
        if (sumXX == 0 || sumYY == 0) return 0;
        
        double r = sumXY / Math.Sqrt(sumXX * sumYY);
        return r * r;  // ✅ 正确计算R²
    }
    catch (Exception ex)
    {
        SimpleLogger.Error("计算R²时发生错误", ex);
        return 0;
    }
}
```

**改进**：
- ✅ 完整的数据准备
- ✅ 正确的线性化
- ✅ 准确的相关系数计算
- ✅ R² = r²

---

## 📈 预期修复效果

### 修复前

```
┌─────────────────────────────────────┐
│ R² 值分布（错误）                    │
├─────────────────────────────────────┤
│                                     │
│     所有模组                         │
│        ↓                            │
│     R² = 0.95                       │
│        │                            │
│        ▼                            │
│    ████████                         │
│    ████████  ← 100%都是0.95         │
│    ████████                         │
│                                     │
│  0.0  0.5  1.0                      │
└─────────────────────────────────────┘
```

### 修复后

```
┌─────────────────────────────────────┐
│ R² 值分布（正确）                    │
├─────────────────────────────────────┤
│                                     │
│      ▁▂▃                            │
│    ▁▃████▅▃▂▁                       │
│  ▂▄██████████▆▄▂                    │
│ ▃███████████████▅▃▁                 │
│                                     │
│ 0.0  0.5  0.9  1.0                  │
│          ↑                          │
│       大部分在0.9以上                 │
│       但有合理分布                    │
└─────────────────────────────────────┘
```

---

## ✅ 验证检查表

修复后，请检查以下项目：

### 功能检查
- [ ] R² 值会随模组变化
- [ ] R² 值在 0-1 范围内
- [ ] 拟合好的模组 R² > 0.95
- [ ] 拟合差的模组 R² < 0.90

### 数值检查
- [ ] 模组A的R²: _____ (应该 ≠ 0.95)
- [ ] 模组B的R²: _____ (应该 ≠ 0.95)
- [ ] 模组C的R²: _____ (应该 ≠ 0.95)

### 其他参数
- [ ] β 值正常
- [ ] η 值正常
- [ ] MTTF 正常
- [ ] B10/B50/B90 正常

---

**问题严重性**: 🔴 高  
**修复难度**: 🟡 中等  
**预计修复时间**: 15-20分钟（方案1）或 5分钟（方案2）
